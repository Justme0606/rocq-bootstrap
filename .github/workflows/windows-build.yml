name: Windows Build & Smoke Test

on:
  push:
    branches: [main, feat/windows]
    paths:
      - "windows/**"
      - "manifest/**"
      - "templates/**"
      - ".github/workflows/windows-build.yml"
  pull_request:
    branches: [main]
    paths:
      - "windows/**"
      - "manifest/**"
      - "templates/**"

jobs:
  build-linux-cross:
    name: Cross-compile from Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Install mingw-w64
        run: sudo apt-get update && sudo apt-get install -y gcc-mingw-w64-x86-64

      - name: Build rocq-bootstrap.exe
        working-directory: windows
        run: make all

      - name: Verify PE32+ executable
        working-directory: windows
        run: file rocq-bootstrap.exe | grep -q "PE32+ executable (GUI) x86-64"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rocq-bootstrap-exe
          path: windows/rocq-bootstrap.exe

  smoke-test-windows:
    name: Smoke test on Windows
    needs: build-linux-cross
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          name: rocq-bootstrap-exe
          path: windows

      - name: Verify exe exists and is valid
        shell: pwsh
        run: |
          $exe = "windows\rocq-bootstrap.exe"
          if (!(Test-Path $exe)) { throw "rocq-bootstrap.exe not found" }
          $size = (Get-Item $exe).Length
          Write-Host "rocq-bootstrap.exe size: $size bytes"
          if ($size -lt 1MB) { throw "exe seems too small ($size bytes)" }

      - name: Test exe starts (headless, expect exit)
        shell: pwsh
        timeout-minutes: 1
        continue-on-error: true
        run: |
          # The GUI exe will fail to create a window in headless CI,
          # but we verify it loads and doesn't crash on missing DLLs.
          $proc = Start-Process -FilePath "windows\rocq-bootstrap.exe" -PassThru -NoNewWindow
          Start-Sleep -Seconds 5
          if (!$proc.HasExited) {
            Write-Host "Process is running (PID: $($proc.Id)), stopping it."
            Stop-Process -Id $proc.Id -Force
            Write-Host "Smoke test passed: exe launched successfully."
          } else {
            Write-Host "Process exited with code: $($proc.ExitCode)"
            Write-Host "Smoke test: exe loaded (headless exit is expected in CI)."
          }

  build-native-windows:
    name: Native build on Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Sync assets
        shell: bash
        working-directory: windows
        run: |
          cp -f ../manifest/latest.json embedded/manifest/latest.json
          cp -f ../templates/test.v embedded/templates/test.v
          cp -f ../templates/vscode-settings.json embedded/templates/vscode-settings.json

      - name: Build natively
        shell: bash
        working-directory: windows
        run: |
          go build -ldflags="-H windowsgui -s -w" -o rocq-bootstrap.exe ./cmd/rocq-bootstrap/

      - name: Verify output
        shell: pwsh
        run: |
          if (!(Test-Path "windows\rocq-bootstrap.exe")) { throw "Build failed" }
          Write-Host "Native build succeeded: $((Get-Item 'windows\rocq-bootstrap.exe').Length) bytes"
